<div class="row">

<div class="col-md-5">
<%= cl_image_tag(@product.code.strip) %>
</div>

<div class="col-md-4">
<p>
  <strong>SKU:</strong>
  <%= @product.code %>
</p>
<p>
<%= @product.description %> <br>
<% if @product.fab %>
<%= @product.fab %>
<% end %>
</p>

<p>
  <% if user_signed_in? %>
	  <% if (current_user.account && current_user.account.approved == 'approved' && current_user.account.seller_level) || ((current_user.has_role? :admin) && (!current_user.mimic.nil?)) %>
	  <!-- if the user has an approved account with a seller level set, then show them their correct price -->
		<% if (current_user.has_role? :admin) && (!current_user.mimic.nil?) %>
                    <% level = current_user.mimic.account.seller_level.to_i %>
                    <% thisperson = current_user.mimic.account.user %>
                  <% else %>
                    <% level = current_user.account.seller_level.to_i %>
                    <% thisperson = current_user %>
                  <% end %> 

                  <% case level %>
                    <% when 1 %>
                      <% prodprice = @product.calc_discount(thisperson, @product.price1, @product.group, @product.code, @product.pricecat) %>
                    <% when 2 %>
                      <% prodprice = @product.calc_discount(thisperson, @product.price2, @product.group, @product.code, @product.pricecat) %>
                    <% when 3 %>
                      <% prodprice = @product.calc_discount(thisperson, @product.price3, @product.group, @product.code, @product.pricecat) %>
                    <% when 4 %>
                      <% prodprice = @product.calc_discount(thisperson, @product.price4, @product.group, @product.code, @product.pricecat) %>
                    <% when 5 %>
                      <% prodprice = @product.calc_discount(thisperson, @product.price5, @product.group, @product.code, @product.pricecat) %>
                    <% when 6 %>
		  		<% prodprice = @product.rrp %>
		  <% end %>
		  $<span id="price-display"><%= number_with_precision(prodprice, precision: 2) %></span>
	  <% end %>

	  <% if user_signed_in? %>
		  <% if current_user.account || ((current_user.has_role? :admin) && (!current_user.mimic.nil?)) %>
			  <% if current_user.account.approved == 'approved' || ((current_user.has_role? :admin) && (!current_user.mimic.nil?)) %>
				  	<%= simple_form_for(@quantity) do |f| %>
				  		<%= f.input :qty, input_html: {value: f.object.qty || '1'} %>
				  		<% if @order %>
				  			<%= f.hidden_field :order_id, value: @order.id %>
				  			<%= f.hidden_field :thisgroup, value: @product.group %>
				  		<% end %>
				  		<%= f.hidden_field :product_id, value: @product.id %>
				  		<%= f.submit "ADD TO CART", class: 'btn btn-success' %>
				  	<% end %>
			  <% end %>
		  <% end %>
	  <% end %>
  <% end %>
</p>
</div>
<% if user_signed_in? %>
  <% if (current_user.orders.any?) && (current_user.orders.last.active == true) %>
  <div class="col-md-3 cart">
      <p>
        <i class="fa fa-shopping-cart fa-2x"></i>
      </p>
      <hr>
      <p>
        <%= render 'orders/sidecart' %>
      </p>
    </div>
  <% elsif (current_user.has_role? :admin) && (!current_user.mimic.nil?) && (current_user.mimic.account.user.orders.any?) && (current_user.mimic.account.user.orders.last.active == true) %>
    <div class="col-md-3 cart">
      <p>
        <i class="fa fa-shopping-cart fa-2x"></i>
      </p>
      <hr>
      <p>
        <%= render 'orders/sidecart' %>
      </p>
    </div>
    <% end %>
  <% end %>
</div>

<script>

$('.form-control').change(function() {
   $.ajax({
      url: '#{products_calc_qty_disc_path}',
      dataType: "json",
      type: "GET",
      data: { qty: $("#quantity_qty").val() },
      success: function(result) {
        $("#price-display").html(result); 
        console.log(result); }
      });
});

</script>
